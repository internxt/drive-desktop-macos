# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane


default_platform(:mac)


platform :mac do
  desc "Build Beta DMG"
  lane :release_ci do

    setup_ci()
    

   
    
    # Prepare certificates using Match
    match(
      type: "developer_id", 
      readonly: true,
      app_identifier: [
        "internxt.InternxtDesktop", 
        "internxt.InternxtDesktop.sync"
      ],
    )

    

    version_number = get_version_number(
      xcodeproj: "InternxtDesktop.xcodeproj",
      target: "InternxtDesktop"
    )

    build_number = get_build_number(xcodeproj: "InternxtDesktop.xcodeproj")
    version = "#{version_number}.#{build_number}-beta"

    app_path = "build/Internxt Drive.app"
    dmg_original_name = "Internxt #{version}.dmg"
    dmg_final_name = "Internxt Drive #{version}.dmg"
    dmg_destination_dir = "build"
      
    # FOR TESTING

    slack(
      message: "[TESTING] Drive Desktop MacOS v#{version} is ready, you can download the DMG for QA here [WIP]",
      slack_url: ENV["SLACK_WEBHOOK_MAC_TEAM"]
    )
    github_release = set_github_release(
      repository_name: "internxt/drive-desktop-macos",
      api_bearer: ENV["GITHUB_TOKEN"],
      is_draft: true,
      is_prerelease: true,
      description: "Drive Desktop #{version} release for MacOS",
      name: "Drive Desktop MacOS #{version}",
      tag_name: "v#{version}",
      #upload_assets: [final_dmg_path]
    )

    

    # ENDFOR TESTING
   
    # Build, archive and sign the .app
    build_mac_app(
      clean: true,
      output_directory: 'build',
      export_method: "developer-id",
      scheme: "InternxtDesktop",
    )

    # Notarize the app
    notarize(
      package: app_path,
      api_key_path: './app_store_key.json'
    )

    # Build the DMG using nodejs create-dmg package
    
    
    Dir.chdir("..") do
      sh("create-dmg", app_path, dmg_destination_dir, "--overwrite")
      # Create a DMG directory
      # Move the DMG to the dmg directory so we can export easily the artifact later in Github Actions
      sh("mv", "./#{dmg_destination_dir}/#{dmg_original_name}", "./#{dmg_destination_dir}/#{dmg_final_name}")
    end


    final_dmg_path = "./#{dmg_destination_dir}/dmg/#{dmg_final_name}"
    # Notarize the DMG file
    notarize(
      bundle_id: "internxt.InternxtDesktop",
      package: final_dmg_path,
      api_key_path: './app_store_key.json'
    )

    # Create a Github Release

    github_release = set_github_release(
      repository_name: "internxt/drive-desktop-macos",
      api_token: ENV["GITHUB_TOKEN"],
      is_draft: true,
      is_prerelease: true,
      description: "Drive Desktop #{version} release for MacOS",
      name: "Drive Desktop MacOS #{version}",
      tag_name: "v#{version}",
      upload_assets: [final_dmg_path]
    )

    release_assets = github_release["assets"]

    dmg_asset = release_assets.find { |asset| asset["name"].include? "dmg" }
    
    dmg_download_url = dmg_asset["browser_download_url"]
    
    slack(
      message: "[TESTING] Drive Desktop MacOS v#{version} is ready, you can download the DMG for QA here #{dmg_download_url}",
      slack_url: ENV["SLACK_WEBHOOK_MAC_TEAM"]
    )

  end
end
