# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane


default_platform(:mac)


platform :mac do
  desc "Build release from CI"
  lane :release_ci do

    setup_ci()
    
    
    # Prepare certificates using Match
    match(
      type: "developer_id", 
      readonly: true,
      app_identifier: [
        "internxt.InternxtDesktop", 
        "internxt.InternxtDesktop.sync"
      ],
    )

    version_number = get_version_number(
      xcodeproj: "InternxtDesktop.xcodeproj",
      target: "InternxtDesktop"
    )

    app_path = "build/Internxt Drive.app"
    dmg_original_name = "Internxt #{version_number}.dmg"
    dmg_final_name = "Internxt Drive #{version_number}.dmg"
    dmg_destination_dir = "build"
    
   
    # Build, archive and sign the .app
    build_mac_app(
      clean: true,
      output_directory: 'build',
      export_method: "developer-id",
      scheme: "InternxtDesktop",
    )

    # Notarize the app
    notarize(
      package: app_path,
      api_key_path: './app_store_key.json'
    )

    # Build the DMG using nodejs create-dmg package
    
    
    Dir.chdir("..") do
      sh("create-dmg", app_path, dmg_destination_dir, "--overwrite")
      # Create a DMG directory
      sh("mkdir", "./#{dmg_destination_dir}/dmg")
      # Move the DMG to the dmg directory so we can export easily the artifact later in Github Actions
      sh("mv", "./#{dmg_destination_dir}/#{dmg_original_name}", "./#{dmg_destination_dir}/dmg/#{dmg_final_name}")
    end


    # Notarize the DMG file
    notarize(
      bundle_id: "internxt.InternxtDesktop",
      package: "./#{dmg_destination_dir}/dmg/#{dmg_final_name}",
      api_key_path: './app_store_key.json'
    )

    # We are done    
     
  end
end
